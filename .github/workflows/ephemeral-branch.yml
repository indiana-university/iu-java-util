# Description
# -----------
# This workflow is intended to run anytime there is a push on a `feature`
# branch, or when a pull request is opened on a `feature`. Ephemeral branches
# follow the format `feature/<some name>`. This workflow is intended to verify build and push API documentation. During workflow execution the branch will
# be marked pending to prevent it from being merged. It must also complete successfully for the
# job to be marked a success, therefore allowing the branch to be merged.

name: Ephemeral Branch

on:
  push:
    branches:
    - feature/**
  workflow_dispatch:

env:
  TZ: America/Indianapolis

jobs:
  verify:
    if: ( github.event_name == 'workflow_dispatch' || github.event_name == 'push' ) && startsWith(github.ref, 'refs/heads/feature/')
    name: Build and Verify Feature Branch
    runs-on: ubuntu-latest

    steps:
       - name: Clone GitHub repository
         uses: actions/checkout@v3
     
       - name: Compile and Build Javadoc
         id: compile
         run: |
          mvn clean verify -DskipTests -U --batch-mode
          
       - name: Verify Test Coverage
         run: |
          mvn verify -Dmaven.javadoc.skip --batch-mode
 
       - name: Publish Documentation
         if: steps.compile.outcome == 'success'
         run: |
          git config --global --add safe.directory $PWD
          git fetch origin github_pages
          git checkout github_pages
          git pull
          rm -rf docs/$GITHUB_REF_NAME
          mkdir -p docs/$GITHUB_REF_NAME
          for a in $(find -type d -regex '.*/\(apidocs\|jacoco\(-aggregate\)?\)' | cut -b3- | egrep -v '^docs/')
          do
            t=docs/$GITHUB_REF_NAME/${a%%target*}
            mkdir -p $t
            mv $a $t
          done
          git config user.name eshrastg
          git config user.email ess-dev-l@iu.edu
          git add docs
          git commit -m "publish $GITHUB_ACTOR $GITHUB_REF_NAME"
          git push

